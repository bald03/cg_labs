#### ***Задание 1. Расчет фоновой и зеркальной (с использованием модели освещения Фонга) составляющих отраженного света. 20 баллов***

Необходимо реализовать возможность учета фоновой (ambient) и зеркальной (specular) составляющих отраженного света при расчете цвета поверхности[^12].
Для этого источник света и материал должны обладать соответствующими свойствами:

- Источник света
  - Цвет диффузного излучения (уже реализовано в примере)
  - Цвет зеркального излучения
  - Цвет фонового излучения
- Материал
  - Цвет диффузного отражения (уже реализовано в примере)
  - Цвет зеркального отражения
  - Цвет фонового отражения
  - Степень зеркального блеска (для формулы Фонга)

#### ***Задание 2. Визуализация теней. 20 баллов***

Необходимо реализовать визуализацию трехмерной сцены с учетом теней, отбрасываемых объектами сцены. Для этого при расчете освещения точки поверхности
проверить отсутствие препятствий на пути света от источника к данной точке.

Вклад диффузной и зеркальной составляющих освещения в общую освещенность точки поверхности должен осуществляться лишь при отсутствии препятствий на
пути света от источника к данной точке.

<img src="images/task2.png" width="300" height="300">

##### Бонус в 20 баллов за создание мягких теней

Бонус начисляется за визуализацию плавных переходов на границе света и тени (полутеней). Для этого точечный источник света должен восприниматься
имеющим некоторые размеры (а не бесконечно малым). Вместо одного вторичного луча из поверхности в сторону источника света испускается несколько
вторичных лучей, направленных в различные точки источника света.

<img src="images/bonus.png" width="300" height="300">

Результирующая интенсивность света, достигшего обрабатываемой точки, равна отношению количества лучей, дошедших до источника света без препятствий, к
общему количеству лучей, запущенному в сторону источника из данной точки.

#### ***Задание 3. Поддержка дополнительных видов трехмерных поверхностей***

**Допускается выполнение нескольких вариантов данного задания. Набранные баллы в этом случае будут суммироваться.**

##### Вариант 1 – Эллиптический параболоид. 50 баллов

Реализовать возможность построения с использованием трассировки лучей геометрический объект «Базовый геометрический параболоид»[^13], состоящий из
боковой поверхности и крышки (круга радиуса 1, лежащего в плоскости z=1).

$$
x^2+y^2-z=0
$$

<img src="images/paraboloid1.png" width="300" height="300">

<img src="images/paraboloid2.png" width="900" height="200">

Создать с использованием данного геометрического объекта композицию наподобие:

<img src="images/composition.png" width="200" height="300">

**Указание:** для нахождения точки пересечения луча с объектом найдите аналитическим способом точки пересечения луча с эллиптическим параболоидом, а
также с крышкой, отбрасывая решения, не удовлетворяющие ограничениям[^14].

Вектор нормали к боковой поверхности должен быть вычислен аналитически используя вектор градиента. Вектор нормали к крышке задать равным (0, 0, 1).

###### *Бонус в 10 баллов за возможность опционального включения и выключения «крышки»*

Бонус начисляется за возможность включения и выключения крышки, закрывающей верхнюю часть эллиптического параболоида.

**Внимание**: при отключенной крышке будет видна как внутренняя, так и внешняя сторона поверхности эллиптического параболоида. Для корректного
вычисления освещенности такой поверхности вектор нормали к поверхности в точке столкновения луча с параболоидом должен быть направлен в
полупространство, в котором находится точка испускания луча.

На следующем рисунке первый луч пересекает эллипсоид в точке P, а второй – в точке Q.

<img src="images/ellipsoid.png" width="450" height="400">

Направление нормали n<sub>1</sub>, восстановленной в точке P, выбирается внутрь эллипсоида, в то время как направление нормали n<sub>2</sub> – наружу.
Т.е. из двух возможных[^15] направлений нормального вектора выбирается то, для которого знак скалярного произведения вектора направления луча и
вектора нормали отрицателен.

Для демонстрации возможности отключения крышки объекта визуализируйте схематическую
модель [параболической антенны](http://ru.wikipedia.org/wiki/%D0%9F%D0%B0%D1%80%D0%B0%D0%B1%D0%BE%D0%BB%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B0%D1%8F_%D0%B0%D0%BD%D1%82%D0%B5%D0%BD%D0%BD%D0%B0) (
для этой цели также понадобится несколько конических цилиндров):

![http://upload.wikimedia.org/wikipedia/commons/f/f8/Antenna_03.JPG](images/parabolic_antenna.jpeg)

##### Вариант 2 – Гиперболический параболоид. 40 баллов

Реализовать возможность построения поверхности базового гиперболического параболоида[^16], заданного на диапазоне координат **x** и **y** от -1 до +1.
Точка пересечения луча с гиперболическим параболоидом должна вычисляться аналитически.

![http://upload.wikimedia.org/wikipedia/ru/8/82/Hip_Par.png](images/Hyperbolic_paraboloid.png)

$x^{2}-y^{2}-z=0$

**Внимание**: при вычислении вектора нормали следует, как и в случае с эллиптическим параболоидом, выбирать направление нормального вектора, скалярное
произведение которого с вектором направления трассируемого луча является отрицательным.

Вектор нормали должен вычисляться аналитическим способом.

##### Вариант 3 – Тор. 100 баллов

Реализовать возможность построения поверхности тора. Должна иметься возможность применения матричных преобразований к тору.

![image](images/torus.png)

$(x^{2}+y^{2}+z^{2}+R^{2}-r^{2})^{2}-4R^{2}(x^{2}+y^{2})=0$, где **R** – расстояние от центра трубы до центра тора, а **r** – радиус трубы.

Для нахождения точек пересечения луча с тором потребуется найти решение уравнения четвертой степени. Сделать это можно
как [аналитическим способом](http://ru.wikipedia.org/wiki/%D0%A3%D1%80%D0%B0%D0%B2%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D1%87%D0%B5%D1%82%D0%B2%D1%91%D1%80%D1%82%D0%BE%D0%B9_%D1%81%D1%82%D0%B5%D0%BF%D0%B5%D0%BD%D0%B8),
так и с использованием численных методов.

С использованием нескольких торов необходимо нарисовать разноцветную детскую пирамидку:

![http://img.4pk.ru/300x10000/images/79/6031179.jpg](images/pyramid.jpeg)

###### *Бонус в 50 баллов за аналитическое нахождение точек пересечения луча с тором*

Бонус начисляется за аналитическое нахождение точки пересечения луча с тором.

##### Вариант 5 – Куб. 30 баллов

Реализовать возможность построения поверхности базового куба. Центр базового куба располагается в точке (0, 0, 0). Стороны куба расположены
параллельно координатным осям. Сторона куба равна 2. Должна иметься возможность применения матричных преобразований к кубу для произвольного
размещения и ориентирования на сцене и создания с его помощью параллелепипеда.

##### Вариант 6 – Тетраэдр. 30 баллов

Реализовать возможность построения произвольного тетраэдра, заданного координатами четырех своих вершин. Должна иметься возможность применения
матричных преобразований к данному объекту для произвольного размещения и ориентирования на сцене.

##### Вариант 7 – Октаэдр. 40 баллов

Реализовать возможность построения базового октаэдра, центр которого расположен в начале координат, а сам октаэдр вписан в сферу единичного радиуса.
Должна иметься возможность применения матричных преобразований к данному объекту для произвольного размещения и ориентирования на сцене.

##### Вариант 8 – Додекаэдр. 50 баллов

Реализовать возможность построения базового додекаэдра, центр которого расположен в начале координат, а сам объект должен быть вписан в сферу
единичного радиуса. Должна иметься возможность применения матричных преобразований к данному объекту для произвольного размещения и ориентирования на
сцене.

##### Вариант 9 – Икосаэдр. 50 баллов

Реализовать возможность построения базового икосаэдра, центр которого расположен в начале координат, а сам объект должен быть вписан в сферу
единичного радиуса. Должна иметься возможность применения матричных преобразований к данному объекту для произвольного размещения и ориентирования на
сцене.

##### Вариант 10 – Метасферы. 120 баллов

Реализовать возможность визуализации гладких криволинейных поверхностей (например, капелек жидкости), задаваемых при помощи метасфер. Должна иметься
возможность применения матричных преобразований к области, содержащей метасферы, для произвольного размещения и ориентирования на сцене.

Для трассировки метасфер необходимо определить ограничивающую область нахождения метасфер (например, внутри прямоугольного параллелепипеда). При
пересечении луча с данным ограничивающим прямоугольником необходимо от точки пересечения выполнять адаптивное перемещение вдоль направления
трассировки с шагом, зависящим от градиента изоповерхности в обрабатываемой точке пространства до приближения к изоповерхности на нужное расстояние.

![image](images/Metaspheres.png)

##### Вариант 11 – Трехмерные модели. 100 баллов

Реализовать возможность визуализации трехмерных полигональных моделей, заданных, например, в формате 3DS. Модель должна визуализироваться с учетом
параметров материалов, связанных с ее гранями. Освещение должно учитывать группы сглаживания граней.

###### *Бонус до 80 баллов за наложение текстуры на грани сетки*

Бонус начисляется за наложение текстуры на грани трехмерных моделей. Реализовать наложение текстуры можно, связав текстурные координаты с каждой
вершиной сетки. При пересечении луча с гранью необходимо выполнять интерполяцию текстурных координат.

За отсутствие фильтрации текстур будет начислено 50% от номинала, за применение билинейной (интерполяция по 4 текселям) фильтрации – 70%, а
трилинейной (интерполяция с применением mip-уровней, по 8 текселям) фильтрации – 100% от номинала данного бонуса.

###### *Бонус до 150 баллов за оптимизацию поиска пересечений с гранями сетки*

Сложные трехмерные модели могут содержать сотни, тысячи и даже десятки тысяч граней. Проверка пересечения луча со всеми гранями сетки в таком случае
сильно замедлит процесс построения изображения. Представление сетки в виде некоторой иерархической структуры (Oct-tree или BSP-tree) позволит
сократить вычислительную сложность трассировки модели с O(N) до O(log N).

Еще один возможный способ оптимизации – использование ограничивающих объемов. Он заключается в проверке пересечений луча с некоторым простым объектом,
например, параллелепипедом или сферой, целиком заключающим внутри себя полигональную сетку, до поиска пересечений луча с гранями сетки. Если
пересечений луча с ограничивающим объемом не найдено, их не будет и с самой сеткой, что позволяет сократить объем вычислений.

Данные способы могут применяться как по отдельности, так и одновременно друг друга. При их отдельной реализации за использование ограничивающих
объемов будет начислено **30 баллов**, а за иерархическое представление модели – **120 баллов**.

### <a name="_toc103989494"></a>**Дополнительная часть**

Задания из данной части принимаются после успешной защиты всех заданий из обязательной части расчетно-графической работы.

#### ***Задание 4. Возможность сохранения построенного в результате трассировки лучей изображения файл. 10 баллов***

При выборе пункта меню или нажатии кнопки панели управления пользователю должно предлагаться сохранить содержимое буфера кадра в файле формата PNG.

#### ***Задание 5. Предварительная интерактивная визуализация сцены с использованием OpenGL. 100 баллов***

Реализовать возможность предварительной визуализации сцены в реальном времени с использованием OpenGL для ориентирования камеры в желаемом
направлении.

После запуска приложение должно переходить в режим интерактивной визуализации.

При нажатии на кнопку на панели инструментов или выборе пункта меню в этом же окне запускается режим визуализации сцены с использованием трассировки
лучей (визуализация при помощи OpenGL в это время отсутствует).

Перед началом трассировки лучей в буфер кадра, используемый трассировщиком, копируется изображение буфера кадра, построенное OpenGL[^17], чтобы можно
было визуально наблюдать процесс обновления изображения и сравнить реалистичность данных подходов визуализации.

Прерывание режима визуализации сцены при помощи трассировки лучей и возврат в режим интерактивной визуализации происходит при щелчке мыши по
клиентской области окна либо изменении размеров окна. При нажатии на кнопку закрытия окна также происходит трассировки лучей и осуществляется закрытие
приложения.

#### ***Задание 6. Использование дополнительных типов источников света***

**Допускается выполнение нескольких вариантов данного задания. Набранные баллы в этом случае будут суммироваться.**

##### Вариант 1. Конический источник света. 30 баллов

Данный источник света характеризуется положением, направлением светового потока, углом разброса лучей, а также степенью ослабления света в зависимости
от отклонения луча от направления.

##### Вариант 2. Бесконечно удаленный источник света (направленный источник света). 20 баллов

Данный источник света характеризуется тем, что направление на него не зависит от положения точки на сцене, а также не происходит ослабления силы света
в зависимости от расстояния.

#### ***Задание 7. Устранение ступенчатости. 20 баллов***

При трассировке лучей возможно возникновение алиасинга (ступенчатых краев) на границах объектов, а также при трассировке удаленных частей сцены (см.
рисунок).

![image](images/Elimination_of_gradation.png)

Реализовать устранение ступенчатости изображения с использованием Distributed Ray Tracing.

**Внимание**: использование данного подхода «в лоб» (т.е. испускание нескольких лучей внутри **каждого** пикселя) способно сильно снизить
быстродействие приложения. Поэтому на практике применяют адаптивные методы, выполняющие трассировку дополнительных лучей (после первого прохода)
только через те пиксели, цвет которых сильно отличается от усредненного значения цветов пикселей в окрестности.

#### ***Задание 8. Создание эффекта смазывания движения (Motion Blur) при визуализации движущихся объектов. 30 баллов***

Для реализации данного функционала с каждым объектом сцены должен быть связан его вектор скорости (расстояние, которое объект проходит за единицу
времени). Для трассировки движущихся объектов также используется подход Distributed Ray Tracing, при котором проверка на столкновение луча с
движущимися объектами осуществляется несколько раз со смещением объектов[^18] вдоль вектора скорости.

#### ***Задание 9. Создание эффекта Depth of field (глубина резкости). 50 баллов***

Данный эффект делает резкими только ту часть сцены, расположенную на определенном расстоянии от камеры. Части сцены, расположенные ближе или дальше
отображаются размыто.

Для создания данного эффекта также используется подход Distributed Ray Tracing.

![image](images/Depth_of_field.png)

#### ***Задание 10. Возможность задания отдельного шейдера для каждой поверхности сложного геометрического объекта. 20 баллов***

Перечисленные геометрические объекты состоят из нескольких поверхностей:

- Конический цилиндр
    - Боковая поверхность
    - Верхняя крышка
    - Нижняя крышка (основание)
- Эллиптический параболоид
    - Поверхность эллиптического параболоида
    - Крышка
- Куб
    - 6 граней
- Тетраэдр
    - 4 грани
- Октаэдр
    - 8 граней
- Додекаэдр
    - 12 граней
- Икосаэдр
    - 20 граней

Необходимо реализовать возможность задания отдельного шейдера для закрашивания каждой поверхности данных объектов, что позволит использовать разные
материалы и разные типы закрашивания.

Для реализации данного функционала потребуется доработать класс CHitInfo, добавив в него индекс поверхности объекта, с которой произошло данное
столкновение.

Также потребуется добавить специальный класс шейдера CMultiSurfaceShader, хранящего ссылки на шейдеры, используемые для закраски поверхностей сложного
объекта. При вызове метода Shade данный шейдер по индексу закрашиваемой поверхности должен поручить шейдеру, связанному с закраской данной
поверхности, задачу по вычислению цвета точки.

Продемонстрировать данный функционал, выполнив визуализацию объекта, входящие в состав которого поверхности используют разные материалы и модели
закрашивания.

#### ***Задание 11. Визуализация отражающих свет объектов. 50 баллов***

Реализовать возможность визуализации объектов, отражающих объекты окружающей среды

#### ***Задание 12. Визуализация преломляющих свет объектов. 80 баллов***

Реализовать физически-обоснованный эффект преломления лучей при прохождении через полупрозрачные объекты.

##### Бонус в 60 баллов за визуализацию эффекта преломления с учетом эффекта дисперсии

#### ***Задание 13. Визуализация трехмерных объектов с использованием физически обоснованных моделей освещения. 60 баллов***

Реализовать шейдер, использующий модель освещения Кука-Торренса (Cook-Torrance shading model).

#### ***Задание 14. Визуализация составных объектов (CSG-objects, - Constructive Solid Geometry или Compound Objects). 150 баллов***

Реализовать логические операции над объемными объектами:

- Пересечение (AND)

![image](images/AND.png)

- Объединение (OR)

![image](images/OR.png)

- Разность (A-B-C-…)

![image](images/Difference.png)

- Симметрическая разность (XOR)

![image](images/Symmetric_difference.png)

#### ***Задание 15. Наложение текстуры на поверхности трехмерных объектов. До 80 баллов***

Реализовать возможность наложения растровых изображений в качестве текстур, задающих диффузную составляющую освещения на стороны объектов

- Плоское наложение
- Цилиндрическое наложение
- Сферическое наложение

#### ***Задание 16. Ускорение визуализации сцены с использованием проекционных экстентов. 40 баллов.***

Оптимизация заключается в следующем. Для каждого объекта сцены предварительно вычисляется проекция его ключевых точек на экране и их ограничивающий
прямоугольник (экстент). При поиске пересечений первичного луча (луча, проходящего из камеры через пиксель экранной плоскости) учитываются только те
объекты сцены, через проекционные экстенты которых проходит данный луч. Для поиска пересечений вторичных лучей (отраженные и преломленные лучи, а
также «щупы теней») этот способ уже не подходит, и следует использовать иные способы оптимизации.

#### ***Задание 17. Визуализация сцены с учетом глобальной освещенности. До 200 баллов.***

Реализовать визуализацию сцены с учетом глобальной освещенности, т.е. при освещении учитывать не только свет от источников света, но также свет,
отраженный от других объектов сцены, а также преломленный свет, что позволяет смягчить освещение, а также смоделировать каустику.

Пример сцены, визуализированной без учета и с учетом глобального освещения.

![http://upload.wikimedia.org/wikipedia/commons/c/c1/Local_illumination.JPG](images/without_global_illumination.jpeg) ![http://upload.wikimedia.org/wikipedia/commons/0/0d/Global_illumination.JPG](images/with_global_illumination.jpeg)

## <a name="_toc103989495"></a>**Литература**

1. [Ф. Хилл. OpenGL. Программирование трехмерной графики](http://www.ozon.ru/context/detail/id/1217778/) (есть также на rutracker.org).
2. [Depth of Field, Fresnel, Blobs](http://www.codermind.com/articles/Raytracer-in-C++-Depth-of-field-Fresnel-blobs.html)
3. [Global Illumination](http://en.wikipedia.org/wiki/Global_illumination) (Wiki)
    - [Path tracing](http://en.wikipedia.org/wiki/Path_tracing)
    - [Photon mapping](http://en.wikipedia.org/wiki/Photon_mapping)
    - [Metropolis light transport](http://en.wikipedia.org/wiki/Metropolis_light_transport)
    - [SmallPT. Простой трассировщик лучей на C, учитывающий глобальное освещение (алгоритм path tracing), в 99 строк кода.](http://www.kevinbeason.com/smallpt/)

[^1]: Строго говоря, можно было бы обойтись традиционными механизмами синхронизации вроде мьютексов, однако в ряде случаев для уменьшения накладных
расходов можно пользоваться неблокирующими атомарными операциями, чем мы и воспользуемся.

[^2]: Автор использует Visual Studio 2008, однако сборки приложения можно использовать и более свежие версии данной среды, а также иную среду
разработки и компилятор.

[^3]: На практике изменения всё же могут понадобиться, т.к. различные компиляторы языка C++ могут реализовывать Стандарт языка по-разному. Кроме того,
могут проявляться различия между операционными системами. Например, в системе Windows регистр символов в имени файла значения не имеет, в то время как
в *nix-системах все обстоит наоборот.

[^4]: Состояние гонки (race condition) – ошибка проектирования многопоточной системы или приложения, при которой работа системы или приложения зависит
от того, в каком порядке выполняются части кода. В нашем случае использование неатомарных операций над одними и теми же переменными из разных потоков
может привести к непредсказуемым результатам работы.

[^5]: Мьютекс будет освобожден в деструкторе класса mutex::scoped_lock.

[^6]: За один блок изображения для простоты примем одну строку изображения. Однако нет никаких препятствий для иного способа разбиения изображения на
блоки, например, на квадратные или прямоугольные блоки.

[^7]: Можно было бы проверять значение этого флага во внутреннем цикле перед обработкой каждого пикселя изображения, однако это повысило бы накладные
расходы на обеспечение синхронизации.

[^8]: Можно было бы воспользоваться директивой **break** для досрочного выхода из цикла, однако использование этой директивы недопустимо внутри
циклов, распараллеливаемых при помощи OpenMP.

[^9]: Ситуации, в которых окну посылается данное сообщение, различаются в реализациях SDL для разных операционных систем. Например, в ОС Windows это
сообщение посылается окну всякий раз, когда область экрана, принадлежащая окну, содержит недействительные данные. Оконная система X Window для
Unix-подобных ОС кеширует содержимое окна, поэтому данное событие окну может и не отправляться со стороны ОС.

[^10]: Т.к. библиотека SDL разработана на языке C, передать в качестве обработчика таймера нестатический метод класса не получится.

[^11]: Такое ограничение необходимо, чтобы избежать переполнения очереди сообщений в ситуации, когда по каким-либо причинам (например, при сильной
загрузке процессора или при высокой частоте таймера) поток, обновляющий содержимое окна, не будет успевать обновлять вслед за потоком таймера,
отдающим команды по обновлению.

[^12]: Для вычисления цвета поверхности в примере используются классы, реализующие интерфейс IShader (шейдер). Приведен пример простейшего шейдера,
выполняющего вычисление диффузного цвета поверхности. Вы можете создать свои классы шейдеров, либо усовершенствовать существующие.

[^13]: Должна иметься возможность применения к данному объекту аффинных преобразования с помощью матриц.

[^14]: Точки пересечения луча с эллиптическим параболоидом с координатой z>1 не должны приниматься в расчет, равно как и точки луча пересечения с
плоскостью z=1, для которых x2+y2>1.

[^15]: Эти направления равны, соответственно, вектору градиента и антиградиента функционально заданной поверхности в точке пересечения луча с
поверхностью.

[^16]: Должна иметься возможность применения к данному объекту аффинных преобразований при помощи матриц.

[^17]: Считать изображение буфера кадра в заданном формате можно при помощи функции OpenGL glReadPixels.

[^18]: На практике может оказаться более эффективным осуществить применение обратной трансформации к лучу, трассирующему объект, т.к. во время
трассировки объекты сцены считаются неизменными.
